<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Genesys Cloud Authenticated WebMessaging Example</title>
    <script src="https://global.oktacdn.com/okta-auth-js/7.4.2/okta-auth-js.min.js"></script>
</head>

<body>

    <h1>Genesys Cloud WebMessaging Example</h1>

    <ul>
        <li><a href="index.html">Genesys Test Site Home Page</a></li>
        <li><a href="#" onclick="signOut()">Sign Out</a></li>
    </ul>

    <div id="login-message"></div>

    <script type="text/javascript">
     
        const oktaConfig = {
            redirectUri: 'https://trial-2736324.okta.com/oauth2/default',
            postLogoutRedirectUri:    'https://api-training-team.github.io/webchat_webmessaging/',
            clientId: '0oatkqs4ij0J17GVy697',
            issuer: 'https://trial-2736324.okta.com/oauth2/default',
            scopes: ['openid', 'email', 'profile', 'offline_access'], 
            pkce: false,
            responseType: 'code',
            maxAge: 3600
        };

        const authClient = new OktaAuth(oktaConfig);

        async function checkAuthentication() {
            try {
                const token = await authClient.tokenManager.get('idToken');

                if (token) {
                    document.getElementById("login-message").innerHTML = `<p>Welcome, ${token.claims.name}!</p>`;
                    initializeGenesysWebMessaging(token.idToken);
                } else {
                    console.log("Usuário não autenticado. Iniciando login...");
                    login();
                }
            } catch (error) {
                console.error("Erro ao verificar autenticação:", error);
                login();
            }
        }

        // Inicia o login via Okta Auth SDK
        async function login() {
            console.log("Redirecionando para login do Okta...");

            try {
                await authClient.token.getWithRedirect({
                    responseType: "code",
                    scopes: oktaConfig.scopes
                });
            } catch (error) {
                console.error("Erro ao iniciar login:", error);
            }
        }

        // Após login, troca o código de autorização por tokens
        async function handleLoginCallback() {
            try {
                const tokenResponse = await authClient.token.parseFromUrl();
                
                if (!tokenResponse.tokens || !tokenResponse.tokens.idToken) {
                    throw new Error("Nenhum token recebido do Okta!");
                }

                // Armazena os tokens no gerenciador do Okta
                authClient.tokenManager.setTokens(tokenResponse.tokens);

                console.log("Tokens armazenados com sucesso!");

                // Remove código da URL
                window.history.replaceState({}, document.title, window.location.pathname);

                checkAuthentication();
            } catch (error) {
                console.error("Erro ao processar callback de login:", error);
            }
        }

<script type="text/javascript" charset="utf-8">
  (function (g, e, n, es, ys) {
    g['_genesysJs'] = e;
    g[e] = g[e] || function () {
      (g[e].q = g[e].q || []).push(arguments)
    };
    g[e].t = 1 * new Date();
    g[e].c = es;
    ys = document.createElement('script'); ys.async = 1; ys.src = n; ys.charset = 'utf-8'; document.head.appendChild(ys);
  })(window, 'Genesys', 'https://apps.mypurecloud.ie/genesys-bootstrap/genesys.min.js', {
    environment: 'prod-euw1',
    deploymentId: '243dcd97-e195-49bd-b234-bb405c772b66'
  });
</script>


</body>

</html>
